parameters:
    - name: environment
    - name: service_name

steps:
    - template: "azure/components/get-aws-secrets-and-ssm-params.yml@common"
      parameters:
        secret_ids:
          - ptl/azure-devops/${{ parameters.service_name }}/${{ parameters.environment }}/JWT_RS512_PRIVATE_KEY
          - ptl/azure-devops/${{ parameters.service_name }}/${{ parameters.environment }}/JWT_RS256_PRIVATE_KEY
          - ptl/azure-devops/${{ parameters.service_name }}/${{ parameters.environment }}/CLIENT_ID
        config_ids: []

    - bash: |
        if [ -d $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests ]; then
          test_dir="$(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests/e2e"

          echo "$(JWT_RS512_PRIVATE_KEY)" >> JWT_RS512_PRIVATE_KEY
          echo "$(JWT_RS256_PRIVATE_KEY)" >> JWT_RS256_PRIVATE_KEY

          echo docker run -v ${test_dir}:/etc/newman -e "JWT_RS256_PRIVATE_KEY=$(JWT_RS256_PRIVATE_KEY)" -e "JWT_RS512_PRIVATE_KEY=$(JWT_RS512_PRIVATE_KEY)" \
          -e "CLIENT_ID=$(CLIENT_ID)" -e "ROOT_PATH=ambulance-analytics-pr-68" -e "BASE_URL=internal-dev" \
          postman/newman:5-ubuntu run ambulance_analytics.json --reporters=cli,junit \
          --global-var \"base_url=internal-dev\" \
          --global-var \"root_path=ambulance-analytics-pr-68\" --global-var \"DEBUG=true\" \
          --global-var \"client_id=$(CLIENT_ID)\" --global-var \"RS256_PRIVATE_KEY=$(cat JWT_RS256_PRIVATE_KEY)\" --global-var \"RS512_PRIVATE_KEY=$(cat JWT_RS512_PRIVATE_KEY)\"

          docker run -v ${test_dir}:/etc/newman -e "JWT_RS256_PRIVATE_KEY=$(JWT_RS256_PRIVATE_KEY)" -e "JWT_RS512_PRIVATE_KEY=$(JWT_RS512_PRIVATE_KEY)" \
          -e "CLIENT_ID=$(CLIENT_ID)" -e "ROOT_PATH=ambulance-analytics-pr-68" -e "BASE_URL=internal-dev" \
          postman/newman:5-ubuntu run ambulance_analytics.json --reporters=cli,junit \
          --global-var \"base_url=internal-dev\" \
          --global-var \"root_path=ambulance-analytics-pr-68\" --global-var \"DEBUG=true\" \
          --global-var \"client_id=$(CLIENT_ID)\" --global-var \"RS256_PRIVATE_KEY=$(cat JWT_RS256_PRIVATE_KEY)\" --global-var \"RS512_PRIVATE_KEY=$(cat JWT_RS512_PRIVATE_KEY)\"
        fi
      displayName: 'Run Postman tests'

    - task: PublishTestResults@2
      displayName: 'Publish Test Results'
      inputs:
          testResultsFiles: |
              $(Pipeline.Workspace)/s/$(SERVICE_NAME)/$(SERVICE_ARTIFACT_NAME)/tests/newman/*.xml
          failTaskOnFailedTests: true
